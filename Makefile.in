AUTOGENERATED_MAKEFILES=@OUTPUT_FILES@
BIN_DIRS=	\
	guilib \
	guilib/common \
	guilib/tinyXML \
	xbmc \
	xbmc/cdrip \
	xbmc/cores \
	xbmc/cores/DllLoader \
	xbmc/cores/DllLoader/exports \
	xbmc/cores/DllLoader/exports/util \
	xbmc/cores/dvdplayer \
	xbmc/cores/dvdplayer/DVDCodecs \
	xbmc/cores/dvdplayer/DVDCodecs/Audio \
	xbmc/cores/dvdplayer/DVDCodecs/Overlay \
	xbmc/cores/dvdplayer/DVDCodecs/Video \
	xbmc/cores/dvdplayer/DVDDemuxers/ \
	xbmc/cores/dvdplayer/DVDInputStreams/ \
	xbmc/cores/dvdplayer/DVDSubtitles/ \
	xbmc/cores/paplayer \
	xbmc/cores/AudioRenderers \
	xbmc/cores/VideoRenderers \
	xbmc/cores/VideoRenderers/VideoShaders \
	xbmc/cores/ExternalPlayer \
	xbmc/cores/playercorefactory \
	xbmc/FileSystem \
	xbmc/FileSystem/MusicDatabaseDirectory \
	xbmc/FileSystem/VideoDatabaseDirectory \
	xbmc/karaoke \
	xbmc/lib/libcmyth \
	xbmc/lib/libhts \
	xbmc/lib/libGoAhead \
	xbmc/lib/libPython \
	xbmc/lib/libPython/xbmcmodule \
	xbmc/lib/libRTMP \
	xbmc/lib/libnbtscan \
	xbmc/lib/libRTV \
	xbmc/lib/libscrobbler \
	xbmc/lib/libshout \
	xbmc/lib/libUPnP \
	xbmc/lib/libXBMS \
	xbmc/lib/libXDAAP \
	xbmc/lib/sqLite \
	xbmc/lib/UnrarXLib \
	xbmc/lib/libsquish \
	xbmc/visualizations \
	xbmc/screensavers \
	xbmc/utils \
	xbmc/settings \
	xbmc/linux \
	xbmc/xbox \
	xbmc/osx 

ifeq (@BOXEEHAL@,1)
  BIN_DIRS+= BoxeeHal/server BoxeeLauncher BoxeeHal/server/helper
endif

ifeq (@EMBEDDED@,1)
  BIN_DIRS+= RecoveryConsole BoxeeWrapper MemLeakDetector
endif

BIN_DIRS+= xbmc/cores/flashplayer xbmc/app xbmc/nativeapp xbmc/cores/dvb

EC_DIRS= \
	tools/EventClients

XBMCTEX_DIRS= \
	tools/TexturePacker

DVDPCODECS_DIRS= \
	xbmc/cores/dvdplayer/Codecs \
        xbmc/cores/dvdplayer/Codecs/libdvd
ifneq (@USE_EXTERNAL_LIBASS@,1)
  DVDPCODECS_DIRS+=xbmc/lib/libass/xbmc
endif

PAPCODECS_DIRS= \
	xbmc/cores/paplayer/AC3Codec \
	xbmc/cores/paplayer/ModuleCodec

ifeq (@BUILD_PAP_APE@,1)
PAPCODEC_DIRS+= \
	xbmc/cores/paplayer/MACDll
endif

ifeq (@BUILD_PAP_WAVPACK@,1)
PAPCODEC_DIRS+= \
  xbmc/cores/paplayer/WavPackCodec
endif

ifeq (@BUILD_PAP_SID@,1)
PAPCODEC_DIRS+= \
  xbmc/cores/paplayer/SIDCodec
endif

ifeq (@BUILD_PAP_NSF@,1)
PAPCODEC_DIRS+= \
  xbmc/cores/paplayer/NSFCodec
endif

ifeq (@BUILD_PAP_VGMSTREAM@,1)
PAPCODEC_DIRS+= \
  xbmc/cores/paplayer/vgmstream
endif

ifeq (@BUILD_PAP_YM@,1)
PAPCODEC_DIRS+= \
  xbmc/cores/paplayer/YMCodec/StSoundLibrary
endif

ifeq (@BUILD_PAP_TIMIDITY@,1)
PAPCODEC_DIRS+= \
  xbmc/cores/paplayer/timidity
endif

ifeq (@BUILD_PAP_GYM@,1)
PAPCODEC_DIRS+= \
  xbmc/cores/paplayer/GYMCodec
endif

ifeq (@BUILD_PAP_SPC@,1)
PAPCODEC_DIRS+= \
  xbmc/cores/paplayer/SPCCodec/SNES/SNESAPU
endif

ifeq (@BUILD_PAP_ADPCM@,1)
PAPCODEC_DIRS+= \
  xbmc/cores/paplayer/ADPCMCodec
endif

ifeq ($(findstring osx,$(ARCH)),osx)
PAPCODEC_DIRS+= \
	xbmc/cores/paplayer/vorbisfile \
	xbmc/cores/paplayer/FLACCodec
endif

LIB_DIRS=\
	xbmc/lib/cximage-6.0 \
	xbmc/lib/libexif \
	xbmc/lib/libhdhomerun \
	xbmc/lib/libid3tag \
	xbmc/lib/libPython/linux \
	xbmc/lib/libjsonrpc \
	xbmc/lib/libplist \
        xbmc/lib/libbluray \
	xbmc/lib/shairport \
	xbmc/lib/sqlite3pp \
	xbmc/lib/w_scan 

LIB_DIRS+= xbmc/lib/libBoxee xbmc/lib/libBoxee/tinyxpath 

SS_DIRS=\
	xbmc/screensavers/rsxs-0.9/xbmc

VIS_DIRS=\
	xbmc/visualizations/OpenGLSpectrum \
	xbmc/visualizations/WaveForm \
	xbmc/visualizations/XBMCProjectM
ifeq (@BUILD_GOOM@,1)
VIS_DIRS+=xbmc/visualizations/Goom
endif

PM3_MEDIA=skin/Project\ Mayhem\ III/media
PM3HD_MEDIA=skin/PM3.HD/media

BOXEE_MEDIA=skin/boxee/media

SKIN_DIRS=\
	$(BOXEE_MEDIA) 

DIRS= $(BIN_DIRS) $(EC_DIRS) $(XBMCTEX_DIRS) $(DVDPCODECS_DIRS) $(PAPCODECS_DIRS) \
	$(LIB_DIRS) $(SS_DIRS) $(VIS_DIRS) $(SKIN_DIRS)

LIBS=@LIBS@
CFLAGS=@CFLAGS@
CXXFLAGS=@CXXFLAGS@
LDFLAGS=@LDFLAGS@
INCLUDES=@INCLUDES@

CLEAN_FILES=Boxee xbmc.bin
DISTCLEAN_FILES=config.h config.log config.status tools/Linux/xbmc.sh \
        autom4te.cache config.h.in~

all : Makefile externals Boxee BoxeeHal RecoveryConsole BoxeeWrapper MemLeakDetector

give_me_my_mouse_back: give_me_my_mouse_back.c
	gcc -g -o give_me_my_mouse_back give_me_my_mouse_back.c -I/opt/local/include -lSDL

include Makefile.include

ifeq ($(findstring osx,$(ARCH)), osx)
  LDFLAGS += -headerpad_max_install_names
endif


ifeq ($(findstring osx,$(ARCH)), osx)
LIBS += -lgdbm -lssl -lcrypto -lresolv xbmc/lib/libsmb/libsmbclient-@ARCH@.a xbmc/lib/libsamplerate/libsamplerate-@ARCH@.a xbmc/lib/libcdio/libcdio-@ARCH@.a xbmc/FileSystem/curl/libcurl-@ARCH@.a xbmc/FileSystem/curl/libidn-@ARCH@.a xbmc/lib/libPython/Python/libpython2.4.a 
LIBS += xbmc/lib/libmms/libmms-@ARCH@.a xbmc/lib/libmms/libintl-@ARCH@.a xbmc/lib/libmms/libglib-2.0-@ARCH@.a
else ifeq (@USE_EXTERNAL_SAMBA@,0)
LIBS += xbmc/lib/libsmb/libsmbclient-@ARCH@.a
else
LIBS += -lsmbclient
endif

ifeq ($(findstring i486-linux,$(ARCH)), i486-linux)
LIBS += xbmc/lib/libPython/Python/libpython2.4.a
endif

.PHONY : dllloader exports visualizations screensavers eventclients papcodecs \
	dvdpcodecs imagelib codecs externals force skins libjsonrpc libplist shairport w_scan sqlite3pp

# hack targets to keep build system up to date
Makefile : configure $(addsuffix .in, $(AUTOGENERATED_MAKEFILES))
	@echo 'The build system is stale'
	@echo 'ATTN: Please (re)run configure...'
	@echo "The following line isn't really an error!"
	@false

configure: configure.in
	@echo 'configure is outdated, regenerating...'
	@./bootstrap
	@echo "The following line isn't really an error!"
	@false

# skin textures
skins: tools/TexturePacker/TexturePacker force
	 $(MAKE) -C $(BOXEE_MEDIA)

$(BOXEE_MEDIA)/Textures.xpr: tools/XBMCTex/XBMCTex $(BOXEE_MEDIA)/*.png $(BOXEE_MEDIA)/*/*.png
	 tools/XBMCTex/XBMCTex -input \"$(BOXEE_MEDIA)\" -output \"$(BOXEE_MEDIA)/Textures.xpr\"

guilib/guilib.a: force
	$(MAKE) -C guilib
guilib/common/gui_common.a: force
	$(MAKE) -C guilib/common
guilib/tinyXML/tinyxml.a: force
	$(MAKE) -C guilib/tinyXML
xbmc/xbmc.a: force
	$(MAKE) -C xbmc
xbmc/cdrip/cdrip.a: force
	$(MAKE) -C xbmc/cdrip
xbmc/cores/cores.a: force
	$(MAKE) -C xbmc/cores
xbmc/cores/DllLoader/dllloader.a: force
	$(MAKE) -C xbmc/cores/DllLoader/
xbmc/cores/DllLoader/exports/exports.a: force
	$(MAKE) -C xbmc/cores/DllLoader/exports
xbmc/cores/DllLoader/exports/util/exports_utils.a: force
	$(MAKE) -C xbmc/cores/DllLoader/exports/util
xbmc/cores/dvdplayer/DVDPlayer.a: force
	$(MAKE) -C xbmc/cores/dvdplayer
xbmc/cores/dvdplayer/DVDCodecs/DVDCodecs.a: force
	$(MAKE) -C xbmc/cores/dvdplayer/DVDCodecs
xbmc/cores/dvdplayer/DVDCodecs/Audio/Audio.a: force
	$(MAKE) -C xbmc/cores/dvdplayer/DVDCodecs/Audio
xbmc/cores/dvdplayer/DVDCodecs/Overlay/Overlay.a: force
	$(MAKE) -C xbmc/cores/dvdplayer/DVDCodecs/Overlay
xbmc/cores/dvdplayer/DVDCodecs/Video/Video.a: force
	$(MAKE) -C xbmc/cores/dvdplayer/DVDCodecs/Video
xbmc/cores/dvdplayer/DVDDemuxers/DVDDemuxers.a: force
	$(MAKE) -C xbmc/cores/dvdplayer/DVDDemuxers
xbmc/cores/dvdplayer/DVDInputStreams/DVDInputStreams.a: force
	$(MAKE) -C xbmc/cores/dvdplayer/DVDInputStreams
xbmc/cores/dvdplayer/DVDSubtitles/DVDSubtitles.a: force
	$(MAKE) -C xbmc/cores/dvdplayer/DVDSubtitles
xbmc/cores/paplayer/paplayer.a: force papcodecs
	$(MAKE) -C xbmc/cores/paplayer
xbmc/cores/flashplayer/flashplayer.a: force
	$(MAKE) -C xbmc/cores/flashplayer
xbmc/cores/AudioRenderers/audiorenderers.a: force
	$(MAKE) -C xbmc/cores/AudioRenderers
xbmc/cores/VideoRenderers/VideoRenderer.a: force
	$(MAKE) -C xbmc/cores/VideoRenderers
xbmc/cores/VideoRenderers/VideoShaders/VideoShaders.a: force
	$(MAKE) -C xbmc/cores/VideoRenderers/VideoShaders
xbmc/cores/ExternalPlayer/ExternalPlayer.a: force
	$(MAKE) -C xbmc/cores/ExternalPlayer
xbmc/cores/dvb/dvb.a: force
	$(MAKE) -C xbmc/cores/dvb
xbmc/cores/playercorefactory/playercorefactory.a: force
	$(MAKE) -C xbmc/cores/playercorefactory
xbmc/FileSystem/filesystem.a: force
	$(MAKE) -C xbmc/FileSystem
xbmc/FileSystem/MusicDatabaseDirectory/musicdatabasedirectory.a: force
	$(MAKE) -C xbmc/FileSystem/MusicDatabaseDirectory
xbmc/FileSystem/VideoDatabaseDirectory/videodatabasedirectory.a: force
	$(MAKE) -C xbmc/FileSystem/VideoDatabaseDirectory
xbmc/karaoke/karaoke.a: force
	$(MAKE) -C xbmc/karaoke
xbmc/lib/libcmyth/libcmyth.a: force
ifeq (@HAS_MYSQLCLIENT@,1)
	$(MAKE) -C xbmc/lib/libcmyth
else
	@echo "not building myth support"
endif
xbmc/lib/libhts/libhts.a: force
	$(MAKE) -C xbmc/lib/libhts
xbmc/lib/libPython/python.a: force
	$(MAKE) -C xbmc/lib/libPython
xbmc/lib/libPython/xbmcmodule/xbmcmodule.a: force
	$(MAKE) -C xbmc/lib/libPython/xbmcmodule
xbmc/lib/libRTMP/librtmp.a: force
	$(MAKE) -C xbmc/lib/libRTMP
xbmc/lib/libnbtscan/libnbtscan.a: force
	$(MAKE) -C xbmc/lib/libnbtscan
xbmc/lib/libscrobbler/scrobbler.a: force
	$(MAKE) -C xbmc/lib/libscrobbler
xbmc/lib/libRTV/librtv-@ARCH@.a: force
	$(MAKE) -C xbmc/lib/libRTV
xbmc/lib/libshout/libshout-@ARCH@.a: force
	$(MAKE) -C xbmc/lib/libshout
xbmc/lib/libUPnP/libupnp-@ARCH@.a: force
	$(MAKE) -C xbmc/lib/libUPnP
xbmc/lib/libXBMS/libxbms-@ARCH@.a: force
	$(MAKE) -C xbmc/lib/libXBMS
xbmc/lib/libXDAAP/libxdaap-@ARCH@.a: force
	$(MAKE) -C xbmc/lib/libXDAAP
xbmc/lib/libGoAhead/libGoAhead-@ARCH@.a: force
	$(MAKE) -C xbmc/lib/libGoAhead
xbmc/lib/sqLite/sqllite.a: force
	$(MAKE) -C xbmc/lib/sqLite
xbmc/lib/UnrarXLib/UnrarXLib.a: force
	$(MAKE) -C xbmc/lib/UnrarXLib
xbmc/lib/libBoxee/libBoxee.a: force
	$(MAKE) -C xbmc/lib/libBoxee
xbmc/lib/libBoxee/tinyxpath/libtinyxpath.a: force
	$(MAKE) -C xbmc/lib/libBoxee/tinyxpath
xbmc/lib/libsquish/libsquish-@ARCH@.a: force
	$(MAKE) -C xbmc/lib/libsquish
xbmc/linux/linux.a: force
	$(MAKE) -C xbmc/linux
xbmc/screensavers/screensaver.a: force
	$(MAKE) -C xbmc/screensavers
xbmc/settings/settings.a: force
	$(MAKE) -C xbmc/settings
xbmc/utils/utils.a: force
	$(MAKE) -C xbmc/utils
xbmc/lib/harfbuzz/harfbuzz/src/.libs/libharfbuzz.a: force
	$(MAKE) -C xbmc/lib/harfbuzz/harfbuzz
xbmc/lib/libjson/libjsoncpp.a: force
	$(MAKE) -C xbmc/lib/libjson/src/lib_json
xbmc/app/app.a: force
	$(MAKE) -C xbmc/app
xbmc/nativeapp/nativeapp.a: force
	$(MAKE) -C xbmc/nativeapp
xbmc/lib/libdvbpsi/src/.libs/libdvbpsi.a: force
ifeq (@EMBEDDED@,1)
	$(MAKE) -C xbmc/lib/libdvbpsi
else
	echo "not building libdvbpsi"
endif

xbmc/visualizations/visualization.a: force
	$(MAKE) -C xbmc/visualizations
xbmc/xbox/xbox.a: force
	$(MAKE) -C xbmc/xbox
xbmc/osx/osx.a: force
	$(MAKE) -C xbmc/osx

xbmc/lib/libBoxeeHalClient/libBoxeeHalClient.a: force
	$(MAKE) -C xbmc/lib/libBoxeeHalClient

BoxeeHal/server/BoxeeHal:
	$(MAKE) -C BoxeeHal/server CXX="$(CXX)"

BoxeeHal/server/helper/BoxeeHelper:
	$(MAKE) -C BoxeeHal/server/helper CXX="$(CXX)"

BoxeeLauncher/BoxeeLauncher:
	$(MAKE) -C BoxeeLauncher CXX="$(CXX)"

exports:
	$(MAKE) xbmc/cores/DllLoader/exports/exports.a
	$(MAKE) xbmc/cores/DllLoader/exports/util/exports_utils.a
	$(MAKE) -C xbmc/cores/DllLoader/exports wrapper.def
dllloader: exports
	$(MAKE) xbmc/cores/DllLoader/dllloader.a
visualizations: exports
ifeq (@BUILD_SPECTRUM@,1)
	$(MAKE) -C xbmc/visualizations/OpenGLSpectrum
endif
ifeq (@BUILD_WAVEFORM@,1)
	$(MAKE) -C xbmc/visualizations/WaveForm
endif
ifeq (@BUILD_PROJECTM@,1)
	$(MAKE) -C xbmc/visualizations/XBMCProjectM
endif
ifeq (@BUILD_GOOM@,1)
ifeq ($(or $(findstring powerpc-linux,$(ARCH)),$(findstring powerpc64-linux,$(ARCH))),)
	$(MAKE) -C xbmc/visualizations/Goom
endif
endif
screensavers: exports
ifeq (@BUILD_RSXS@,1)
	$(MAKE) -C xbmc/screensavers/rsxs-0.9/xbmc
else
	@echo "not building rsxs"
endif
libpython: dllloader
	$(MAKE) -C xbmc/lib/libPython
	$(MAKE) -C xbmc/lib/libPython/xbmcmodule
python: dllloader
	$(MAKE) -C xbmc/lib/libPython/linux
dvdpcodecs: dllloader
	$(MAKE) -C xbmc/cores/dvdplayer/Codecs
	$(MAKE) -C xbmc/cores/dvdplayer/Codecs/libdvd
ifneq (@USE_EXTERNAL_LIBASS@,1)
	$(MAKE) -C xbmc/lib/libass/xbmc
endif
eventclients:
ifeq ($(findstring osx,$(ARCH)), osx)
	$(MAKE) -C tools/EventClients/Clients/OSXRemote
else
	$(MAKE) -C tools/EventClients
endif
libexif: dllloader
	$(MAKE) -C xbmc/lib/libexif
libhdhomerun: dllloader
	$(MAKE) -C xbmc/lib/libhdhomerun
libid3tag: dllloader
	$(MAKE) -C xbmc/lib/libid3tag
libbluray: dllloader
	$(MAKE) -C xbmc/lib/libbluray
ifneq ($(findstring osx,$(ARCH)), osx)
	cp xbmc/lib/libbluray/src/.libs/libbluray.so.0.0.0 system/players/dvdplayer/libbluray.so
else
	cp xbmc/lib/libbluray/src/.libs/libbluray.0.dylib system/players/dvdplayer/libbluray.so
endif
papcodecs: dllloader dvdpcodecs
	$(MAKE) -C xbmc/cores/paplayer/AC3Codec
ifeq (@BUILD_PAP_ADPCM@,1)
	$(MAKE) -C xbmc/cores/paplayer/ADPCMCodec
endif
ifeq ($(findstring osx,$(ARCH)), osx)
	$(MAKE) -C xbmc/cores/paplayer/FLACCodec
	$(MAKE) -C xbmc/cores/paplayer/vorbisfile
endif
ifeq (@BUILD_PAP_GYM@,1)
	$(MAKE) -C xbmc/cores/paplayer/GYMCodec
endif
ifeq (@BUILD_PAP_VGMSTREAM@,1)
	$(MAKE) -C xbmc/cores/paplayer/vgmstream
endif
ifeq (@BUILD_PAP_TIMIDITY@,1)
	$(MAKE) -C xbmc/cores/paplayer/timidity
endif
ifeq (@BUILD_PAP_NSF@,1)
	$(MAKE) -C xbmc/cores/paplayer/NSFCodec
endif
ifeq (@BUILD_PAP_SID@,1)
	$(MAKE) -C xbmc/cores/paplayer/SIDCodec
endif
	$(MAKE) -C xbmc/cores/paplayer/ModuleCodec
ifeq (@BUILD_PAP_WAVPACK@,1)
ifneq (@USE_EXTERNAL_LIBWAVPACK@,1)
	$(MAKE) -C xbmc/cores/paplayer/WavPackCodec
endif
endif
	$(MAKE) -C xbmc/cores/paplayer/YMCodec/StSoundLibrary	
ifeq (@BUILD_PAP_APE@,1)
ifeq ($(findstring powerpc,$(ARCH)),)
	$(MAKE) -C xbmc/cores/paplayer/MACDll
endif
endif
ifeq (@BUILD_PAP_SPC@,1)
ifeq ($(or $(findstring arm,$(ARCH)), $(or $(findstring powerpc,$(ARCH)),$(findstring x86_64-linux,$(ARCH))),),)
	$(MAKE) -C xbmc/cores/paplayer/SPCCodec/SNES/SNESAPU
endif
endif
imagelib: dllloader
	$(MAKE) -C xbmc/lib/cximage-6.0
libjsonrpc: 
	$(MAKE) -C xbmc/lib/libjsonrpc
libplist: 
	$(MAKE) -C xbmc/lib/libplist
sqlite3pp: 
	$(MAKE) -C xbmc/lib/sqlite3pp
shairport: 
	$(MAKE) -C xbmc/lib/shairport
w_scan: 
ifeq ($(findstring 86-linux,$(ARCH)),86-linux)	
	$(MAKE) -C xbmc/lib/w_scan
else
	echo "not building w_scan"
endif

codecs: papcodecs dvdpcodecs
libs: libhdhomerun libid3tag imagelib libexif python libbluray libjsonrpc libplist sqlite3pp shairport w_scan
externals: codecs libs python visualizations screensavers

xcode_depends: \
	codecs libs python visualizations screensavers eventclients \
	xbmc/lib/libsquish/libsquish-@ARCH@.a \
	skins \
	xbmc/lib/libRTMP/librtmp.a \
	xbmc/lib/libXBMS/libxbms-@ARCH@.a \
	xbmc/lib/libRTV/librtv-@ARCH@.a \
	xbmc/lib/libXDAAP/libxdaap-@ARCH@.a \
	xbmc/lib/libshout/libshout-@ARCH@.a \
	xbmc/lib/libGoAhead/libGoAhead-@ARCH@.a

# platform independend objects
OBJSXBMC=	\
	xbmc/xbmc.a \
	xbmc/cores/playercorefactory/playercorefactory.a \
	xbmc/cores/dvdplayer/DVDPlayer.a \
	xbmc/cores/paplayer/paplayer.a \
	xbmc/cores/VideoRenderers/VideoRenderer.a \
	xbmc/cores/VideoRenderers/VideoShaders/VideoShaders.a \
	guilib/guilib.a \
	guilib/common/gui_common.a \
	guilib/tinyXML/tinyxml.a \
	xbmc/cdrip/cdrip.a \
	xbmc/cores/cores.a \
	xbmc/lib/libPython/python.a \
	xbmc/cores/DllLoader/dllloader.a \
	xbmc/cores/dvdplayer/DVDCodecs/DVDCodecs.a \
	xbmc/cores/dvdplayer/DVDCodecs/Audio/Audio.a \
	xbmc/cores/dvdplayer/DVDCodecs/Overlay/Overlay.a \
	xbmc/cores/dvdplayer/DVDCodecs/Video/Video.a \
	xbmc/cores/dvdplayer/DVDDemuxers/DVDDemuxers.a \
	xbmc/cores/dvdplayer/DVDInputStreams/DVDInputStreams.a \
	xbmc/cores/dvdplayer/DVDSubtitles/DVDSubtitles.a \
	xbmc/cores/AudioRenderers/audiorenderers.a \
	xbmc/cores/ExternalPlayer/ExternalPlayer.a \
	xbmc/FileSystem/filesystem.a \
	xbmc/FileSystem/MusicDatabaseDirectory/musicdatabasedirectory.a \
	xbmc/FileSystem/VideoDatabaseDirectory/videodatabasedirectory.a \
	xbmc/karaoke/karaoke.a \
	xbmc/lib/libhts/libhts.a \
	xbmc/lib/libPython/xbmcmodule/xbmcmodule.a \
	xbmc/lib/libRTMP/librtmp.a \
	xbmc/lib/libnbtscan/libnbtscan.a \
	xbmc/lib/libscrobbler/scrobbler.a \
	xbmc/lib/libRTV/librtv-@ARCH@.a \
	xbmc/lib/libshout/libshout-@ARCH@.a \
	xbmc/lib/libUPnP/libupnp-@ARCH@.a \
	xbmc/lib/libXBMS/libxbms-@ARCH@.a \
	xbmc/lib/libXDAAP/libxdaap-@ARCH@.a \
	xbmc/lib/libGoAhead/libGoAhead-@ARCH@.a \
	xbmc/lib/sqLite/sqllite.a \
	xbmc/lib/UnrarXLib/UnrarXLib.a \
	xbmc/lib/libsquish/libsquish-@ARCH@.a \
	xbmc/lib/libjsonrpc/libjsonrpc.a \
	xbmc/lib/libplist/libplist.a \
	xbmc/lib/shairport/libshairport.a \
	xbmc/screensavers/screensaver.a \
	xbmc/settings/settings.a \
	xbmc/visualizations/visualization.a \
	xbmc/xbox/xbox.a \
	xbmc/lib/harfbuzz/harfbuzz/src/.libs/libharfbuzz.a \
	xbmc/lib/libjson/libjsoncpp.a \
	xbmc/nativeapp/nativeapp.a \
	xbmc/lib/libBoxee/libBoxee.a \
	xbmc/lib/libBoxee/tinyxpath/libtinyxpath.a \
	xbmc/cores/flashplayer/flashplayer.a \
	xbmc/cores/dvb/dvb.a \
	xbmc/lib/sqlite3pp/sqlite3pp.a \

ifeq (@BOXEEHAL@,1)
OBJSXBMC+= xbmc/lib/libBoxeeHalClient/libBoxeeHalClient.a
endif

ifeq (@EMBEDDED@,1)
OBJSXBMC+= xbmc/lib/libdvbpsi/src/.libs/libdvbpsi.a
endif


DYNOBJSXBMC= \
	xbmc/linux/linux.a \
	xbmc/utils/utils.a \
	xbmc/cores/DllLoader/exports/util/exports_utils.a \
	xbmc/cores/DllLoader/exports/exports.a \
	xbmc/app/app.a

ifeq (@HAS_MYSQLCLIENT@,1)
DYNOBJSXBMC += \
        xbmc/lib/libcmyth/libcmyth.a
endif

# platform dependend objects
ifeq ($(findstring osx,$(ARCH)), osx)
OBJSXBMC += \
	xbmc/osx/osx.a \
	xbmc/lib/libSDL-OSX/libSDL-@ARCH@.a
endif

xbmc.bin: $(OBJSXBMC) $(DYNOBJSXBMC)
ifeq ($(findstring osx,$(ARCH)), osx)
	$(CXX) $(CXXFLAGS) -o xbmc.bin -Wl,-all_load,-ObjC $(DYNOBJSXBMC) $(OBJSXBMC) $(LIBS) $(LDFLAGS) -rdynamic
else
	$(CXX) $(CXXFLAGS) -o xbmc.bin -Wl,--whole-archive $(DYNOBJSXBMC) -Wl,--no-whole-archive $(OBJSXBMC) $(LIBS) $(LDFLAGS) -rdynamic
endif

Boxee: $(OBJSXBMC) $(DYNOBJSXBMC)
ifeq ($(findstring osx,$(ARCH)), osx)
	$(CXX) $(CXXFLAGS) $(DEBUG_FLAGS) $(LDFLAGS) -o Boxee -Wl,-all_load,-ObjC $(DYNOBJSXBMC) $(OBJSXBMC) $(LIBS) -rdynamic
else
	$(CXX) $(CXXFLAGS) $(DEBUG_FLAGS) -o Boxee -Wl,--whole-archive $(DYNOBJSXBMC) -Wl,--no-whole-archive $(OBJSXBMC) $(LIBS) $(LDFLAGS) -rdynamic
endif
ifeq (@BOXEEHAL@,1)
BoxeeHal: BoxeeHal/server/BoxeeHal BoxeeHal/server/helper/BoxeeHelper BoxeeLauncher/BoxeeLauncher
	make -C BoxeeHal/server
	make -C BoxeeHal/server/helper
	make -C BoxeeLauncher
endif
ifeq (@EMBEDDED@,1)
RecoveryConsole/Makefile : RecoveryConsole/RecoveryConsole.pro
	(cd RecoveryConsole; ./compile_ce4100.sh)

RecoveryConsole/RecoveryConsole : RecoveryConsole/Makefile
	make -C RecoveryConsole

RecoveryConsole: RecoveryConsole/RecoveryConsole

BoxeeWrapper/bxwrapper.so:
	make -C BoxeeWrapper

BoxeeWrapper: BoxeeWrapper/bxwrapper.so

MemLeakDetector/leakdetector.so:
	make -C MemLeakDetector

MemLeakDetector : MemLeakDetector/leakdetector.so
endif

xbmc-xrandr: xbmc-xrandr.c
ifneq (@HAS_MYSQLCLIENT@,1)
	# xbmc-xrandr.c gets picked up by the default make rules
	#  so only exclude it for osx builds
	@echo "excluding xbmc-xrandr"
else
	$(CC) $(CFLAGS) -o xbmc-xrandr xbmc-xrandr.c -lXrandr -lXrender -lX11 
endif

tools/XBMCTex/XBMCTex:
ifeq ($(findstring osx,$(ARCH)), osx)
	# hack this for now
	$(MAKE) -C tools/XBMCTex -f Makefile.osx
else
	$(MAKE) -C tools/XBMCTex/
endif

tools/TexturePacker/TexturePacker:
	$(MAKE) -C tools/TexturePacker/

install-bin: Boxee # developement convenience target
	sudo install -D  Boxee $(prefix)/share/boxee

ifeq ($(findstring osx,$(ARCH)), osx)
	# TODO: add osx install
else
install:
	@echo "Copying XBMC binary to $(prefix)/share/xbmc/xbmc.bin"
	@install -D xbmc.bin $(prefix)/share/xbmc/xbmc.bin
	@install -D xbmc-xrandr $(prefix)/share/xbmc/xbmc-xrandr
	@install -D tools/Linux/xbmc.sh $(prefix)/bin/xbmc
	@install -D tools/Linux/xbmc-standalone.sh $(prefix)/bin/xbmc-standalone
	@install -D -m 0644 tools/Linux/FEH.py $(prefix)/share/xbmc/FEH.py
	@install -D -m 0644 tools/Linux/xbmc-xsession.desktop $(prefix)/share/xsessions/XBMC.desktop
	@echo "Copying support and legal files..."
	@for FILE in `ls README.linux LICENSE.GPL *.txt`; do \
		install -D -m 0644 "$$FILE" $(prefix)/share/xbmc/; done
	@echo "Done!"
	@echo "You can run XBMC with the command 'xbmc'"
	@$(MAKE) install-datas
	@$(MAKE) install-web
endif

install-datas:
	@echo "Copying system files to $(prefix)/share/xbmc"
	@# Arch independent files
	@find language media scripts sounds userdata visualisations system -regextype posix-extended -type f -not -iregex ".*svn.*|.*\.so|.*\.dll|.*\.pyd|.*python/.*\.zlib|.*\.vis" -exec install -D -m 0644 "{}" $(prefix)/share/xbmc/"{}" \; -printf " -- %-75.75f\r"
	@# Arch dependent files
	@find system screensavers visualisations -regextype posix-extended -type f -not -iregex ".*svn.*|.*win32\.vis|.*osx\.vis" -iregex ".*$(ARCH).*|.*\.vis|.*\.xbs" -exec install -D "{}" $(prefix)/share/xbmc/"{}" \; -printf " -- %-75.75f\r"
	@# Skins
	@find skin -regextype posix-extended -type f -not -iregex ".*svn.*|.*\.png|.*\.gif" -exec install -D -m 0644 '{}' $(prefix)/share/xbmc/'{}' \; -printf " -- %-75.75f\r"

install-livedatas:
	@echo "Install Live CD datas in $(prefix) ..."
	@install -D tools/XBMCLive/diskmounter $(prefix)/bin
	@install -D tools/XBMCLive/installXBMC $(prefix)/bin
	@install -D tools/XBMCLive/runXBMC $(prefix)/bin
	@install -D tools/XBMCLive/setAlsaVolumes $(prefix)/bin

install-web:
	@mkdir -p $(prefix)/share/xbmc/web
	@cp -r web/Project_Mayhem_III/* $(prefix)/share/xbmc/web
	@find $(prefix)/share/xbmc/web -depth -name .svn -exec rm -rf {} \;

uninstall:
	@echo "Removing XBMC..."
	@rm -rf $(prefix)/share/xbmc $(prefix)/bin/xbmc
	@rm -rf $(prefix)/bin/xbmc-standalone
	@rm -rf $(prefix)/share/xsessions/XBMC.desktop
	@echo "Done!"

reallyclean:
	@echo " This will delete ALL unversioned files in"; \
	 echo " your XBMC source tree. If you aren't sure"; \
	 echo " you want to do this, answer anything but"; \
	 echo " 'Y' (case sensitive) to the following."; \
	 echo " DISCLAIMER: Team XBMC is NOT responsible"; \
	 echo " for ANYTHING lost if you execute this command!"; \
	 echo -n " Damnserious? (Y/*) "; \
	 read -n1 PROMPT; \
	 if [[ "$$PROMPT" = "Y" ]]; then \
		SVNV=$$(svnversion -n | cut -d':' -f1); _IFS=$$IFS; IFS=$$'\t\n'; \
		for i in `svn st --no-ignore | grep ^[I\?] | cut -d' ' -f7-`; do \
			if [[ $${i:(-4)} != "diff" && $${i:(-5)} != "patch" ]]; then \
				echo "  Deleting $$i"; \
				rm -rf "$$i"; \
			fi; \
		done; \
		IFS=$$_IFS; \
		echo " Recovering any missing files."; \
		svn up -r $${SVNV/M/} | sed -e "s/.*'\(.*\)'/  \1/p" -e d; \
		echo " Done."; \
		echo " The following files may need reverted (svn revert <file>)"; \
		svn st | sed -e "s/^M */  /p" -e d; \
	 else \
	 	echo; \
	 fi

clean-Boxee:
	rm -f Boxee
	for d in $(BIN_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-xbmc.bin:
	rm -f xbmc.bin
	for d in $(BIN_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-eventclients:
	for d in $(EC_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-xbmctex:
	for d in $(XBMCTEX_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-dvdpcodecs: 
	for d in $(DVDPCODECS_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-papcodecs:
	for d in $(PAPCODECS_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-libs: 
	for d in $(LIB_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-screensavers: 
	for d in $(SS_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-visualisations:
	for d in $(VIS_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done

clean-codecs: clean-dvdpcodecs clean-papcodecs

clean-externals: clean-codecs clean-eventclients clean-xbmctex clean-libs \
	clean-screensavers clean-visualisations

release:
	@expr `git log --pretty=oneline | wc -l` + 15012 | tr -d '\n' > REVISION
	@echo -n '-' >> REVISION
	@echo -n $(shell git rev-parse --short HEAD) >> REVISION
	@cat xbmc/linux/svn_rev.h.in  | sed 's/WCREV/'`cat REVISION`/ > xbmc/linux/svn_rev.h
	@echo -n $(shell cat xbmc/lib/libBoxee/bxversion.h | grep BOXEE_VERSION | awk '{print $$3}' | sed 's/"//g') > VERSION
	@echo -n . >> VERSION
	@cat REVISION >> VERSION
	make all
